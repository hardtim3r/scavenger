<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Scavenger Hunt â€“ Wijzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background: #050814;
      color: #f7f7ff;
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .compass-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    /* Buitenring met glow */
    .ring {
      position: absolute;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 2px solid rgba(180,160,255,0.3);
      box-shadow:
        0 0 30px rgba(160,120,255,0.25),
        inset 0 0 30px rgba(120,80,255,0.25);
      animation: pulse 4s ease-in-out infinite;
      top: 0;
      left: 0;
    }

    @keyframes pulse {
      0%   { box-shadow: inset 0 0 25px rgba(140,90,255,0.15); }
      50%  { box-shadow: inset 0 0 45px rgba(190,120,255,0.35); }
      100% { box-shadow: inset 0 0 25px rgba(140,90,255,0.15); }
    }

    /* Klok-stippen */
    .ticks {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .tick {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 8px rgba(255,255,255,0.5);
    }

    .tick.major {
      width: 8px;
      height: 8px;
      background: #ffffff;
    }

    /* Wijzer (naald) â€“ draait om het punt in het midden */
    .needle {
      position: absolute;
      width: 4px;
      height: 120px;
      background: #ffffff;
      top: 50%;
      left: 50%;
      transform-origin: 50% 100%; /* onderste punt is draaipunt */
      border-radius: 2px;
      filter: drop-shadow(0 0 10px #a985ff);
    }

    /* stip in het midden */
    .center-dot {
      position: absolute;
      width: 14px;
      height: 14px;
      background: #ffffff;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255,255,255,0.6);
    }

    .status {
      position: absolute;
      bottom: -60px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      padding: 0 1rem;
      box-sizing: border-box;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffb3ff, #9f9cff);
      color: #141414;
      cursor: pointer;
    }

    button:active {
      transform: scale(0.96);
    }

    #continue-btn {
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
    }

    /* iOS kompas-activatieknop */
    #enable-compass-btn {
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      padding: 10px 20px;
      display: none; /* alleen tonen als requestPermission bestaat */
      background: rgba(255,255,255,0.9);
    }

    /* INTRO OVERLAY */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 55%), #050814;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .intro-box {
      max-width: 420px;
      padding: 28px 24px 24px;
      border-radius: 24px;
      background: rgba(5, 7, 18, 0.96);
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      text-align: center;
      backdrop-filter: blur(14px);
    }

    .intro-text {
      font-size: 1.9rem;
      line-height: 1.45;
      font-weight: 500;
      margin: 0;
      opacity: 0;
    }

    .intro-text.fade-in {
      animation: introFade 0.8s ease forwards;
    }

    @keyframes introFade {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>

  <!-- INTRO OVERLAY -->
  <div class="intro-overlay" id="intro-overlay">
    <div class="intro-box">
      <p id="intro-text" class="intro-text"></p>
    </div>
  </div>

  <div class="compass-wrapper">
    <div class="ring"></div>

    <!-- klok-stippen -->
    <div class="ticks">
      <div class="tick major" style="transform: translate(-50%, -50%) rotate(0deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(30deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(60deg) translateY(-140px);"></div>
      <div class="tick major" style="transform: translate(-50%, -50%) rotate(90deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(120deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(150deg) translateY(-140px);"></div>
      <div class="tick major" style="transform: translate(-50%, -50%) rotate(180deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(210deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(240deg) translateY(-140px);"></div>
      <div class="tick major" style="transform: translate(-50%, -50%) rotate(270deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(300deg) translateY(-140px);"></div>
      <div class="tick"        style="transform: translate(-50%, -50%) rotate(330deg) translateY(-140px);"></div>
    </div>

    <div id="needle" class="needle"></div>
    <div class="center-dot"></div>

    <button id="enable-compass-btn">Activeer kompas</button>

    <p id="status" class="status">Locatie & richting worden geladenâ€¦</p>

    <button id="continue-btn">Ga verder</button>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const TARGET_LAT = 51.4500556;
    const TARGET_LON = 5.454944;
    const UNLOCK_RADIUS_METERS = 40;
    const NEXT_URL = "eind.html";

    /* ========= STATE ========= */
    const needle = document.getElementById('needle');
    const statusEl = document.getElementById('status');
    const continueBtn = document.getElementById('continue-btn');
    const enableCompassBtn = document.getElementById('enable-compass-btn');
    const compassWrapper = document.querySelector('.compass-wrapper');

    const introOverlay = document.getElementById('intro-overlay');
    const introTextEl  = document.getElementById('intro-text');

    let heading = null;
    let userLat = null;
    let userLon = null;
    let targetBearing = null;
    let distanceToTarget = null;
    let unlocked = false;
    let orientationActive = false;

    let displayAngle = 0;
    let desiredAngle = 0;

    /* ========= INTRO SEQUENCE ========= */
    const introMessages = [
      "Hey Emi",
      "Time will show",
      "Right?"
    ];

    function runIntro() {
      let idx = 0;
      const DISPLAY_TIME = 3400;

      function nextMessage() {
        if (idx >= introMessages.length) {
          introOverlay.style.transition = "opacity 0.45s ease";
          introOverlay.style.opacity = "0";
          setTimeout(() => {
            introOverlay.style.display = "none";
            compassWrapper.style.opacity = "1";
            compassWrapper.style.transform = "translateY(0)";
          }, 450);
          return;
        }

        introTextEl.classList.remove("fade-in");
        void introTextEl.offsetWidth; // reflow
        introTextEl.textContent = introMessages[idx];
        introTextEl.classList.add("fade-in");

        idx++;
        setTimeout(nextMessage, DISPLAY_TIME);
      }

      nextMessage();
    }

    /* ========= HELPERS ========= */
    function toRad(x){return x*Math.PI/180;}
    function toDeg(x){return x*180/Math.PI;}

    function distanceInMeters(lat1, lon1, lat2, lon2){
      const R=6371000;
      const dLat=toRad(lat2-lat1);
      const dLon=toRad(lon2-lon1);
      const a=
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function bearingDegrees(lat1, lon1, lat2, lon2){
      const Ï†1=toRad(lat1);
      const Ï†2=toRad(lat2);
      const dLon=toRad(lon2-lon1);
      const y=Math.sin(dLon)*Math.cos(Ï†2);
      const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(dLon);
      return (toDeg(Math.atan2(y,x))+360)%360;
    }

    function shortestAngleDiff(from, to) {
      let diff = (to - from + 540) % 360 - 180;
      return diff;
    }

    function updateDesiredAngle() {
      if (heading == null || targetBearing == null) return;
      const diff = (targetBearing - heading + 360) % 360;
      desiredAngle = diff;
    }

    function checkUnlock(){
      if (unlocked) return;
      if (distanceToTarget != null && distanceToTarget <= UNLOCK_RADIUS_METERS){
        unlocked = true;
        statusEl.textContent = "Dit klopt. ðŸŒ™";
        continueBtn.style.display = "inline-block";
      }
    }

    /* ========= GEO ========= */
    function startGeo(){
      if (!navigator.geolocation){
        statusEl.textContent="Geen GPS beschikbaar.";
        return;
      }

      navigator.geolocation.watchPosition(
        pos=>{
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;

          distanceToTarget = distanceInMeters(userLat,userLon,TARGET_LAT,TARGET_LON);
          targetBearing = bearingDegrees(userLat,userLon,TARGET_LAT,TARGET_LON);

          if (!unlocked) statusEl.textContent = "";
          updateDesiredAngle();
          checkUnlock();
        },
        err=>{
          statusEl.textContent="GPS werkt niet goed.";
        },
        {enableHighAccuracy:true, timeout:10000, maximumAge:1000}
      );
    }

    /* ========= COMPASS ========= */
    function attachOrientationListener() {
      if (orientationActive) return;
      orientationActive = true;

      function onOrientation(ev){
        if (ev.webkitCompassHeading != null){
          heading = ev.webkitCompassHeading; // iOS
        } else if (ev.alpha != null){
          heading = ev.alpha; // Android
        }
        updateDesiredAngle();
      }

      window.addEventListener("deviceorientation", onOrientation, true);
    }

    function startCompass(){
      if (typeof DeviceOrientationEvent === "undefined"){
        statusEl.textContent="Geen kompas-toegang.";
        return;
      }

      if (typeof DeviceOrientationEvent.requestPermission === "function"){
        enableCompassBtn.style.display = "inline-block";
        enableCompassBtn.addEventListener("click", () => {
          DeviceOrientationEvent.requestPermission()
            .then(resp=>{
              if (resp==="granted"){
                attachOrientationListener();
                enableCompassBtn.style.display = "none";
                if (!unlocked) statusEl.textContent = "";
              } else {
                statusEl.textContent="Kompas-toegang geweigerd.";
              }
            })
            .catch(()=>{
              statusEl.textContent="Kompas-toegang mislukt.";
            });
        });
      } else {
        attachOrientationListener();
      }
    }

    /* ========= ANIMATIE-LOOP ========= */
    function animateNeedle() {
      const diff = shortestAngleDiff(displayAngle, desiredAngle);
      const SMOOTHING = 0.15;
      displayAngle += diff * SMOOTHING;
      needle.style.transform = `translate(-50%, -100%) rotate(${displayAngle}deg)`;
      requestAnimationFrame(animateNeedle);
    }

    /* ========= INIT ========= */
    displayAngle = 0;
    desiredAngle = 0;
    needle.style.transform = "translate(-50%, -100%) rotate(0deg)";

    window.addEventListener("load", () => {
      runIntro();
      startGeo();
      startCompass();
      animateNeedle();
    });

    continueBtn.addEventListener("click", ()=>{
      window.location.href = NEXT_URL;
    });
  </script>
</body>
</html>
